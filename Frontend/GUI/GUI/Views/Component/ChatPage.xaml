<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:RestaurantManagementGUI"
             x:Class="RestaurantManagementGUI.ChatPage"
             Title="Há»‡ thá»‘ng tin nháº¯n"
             BackgroundColor="White">

    <ContentPage.Resources>
        <ResourceDictionary>
            <local:InverseBooleanConverter x:Key="InverseBooleanConverter" />
            <local:GreaterThanZeroConverter x:Key="GreaterThanZeroConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid ColumnDefinitions="350,*" RowDefinitions="*">

        <Grid Grid.Column="0" RowDefinitions="Auto,Auto,Auto,*,Auto" BackgroundColor="White">

            <BoxView Grid.RowSpan="5" HorizontalOptions="End" WidthRequest="1" Color="#E4E6EB"/>

            <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" Padding="15,15,15,5">
                <Button Text="â†" BackgroundColor="Transparent" TextColor="#333" FontSize="24" Padding="0" WidthRequest="30" HorizontalOptions="Start"/>
                <Label Grid.Column="1" Text="Tin nháº¯n" FontAttributes="Bold" FontSize="22" TextColor="Black" VerticalOptions="Center" Margin="5,0,0,0"/>

                <HorizontalStackLayout Grid.Column="2" Spacing="8">
                    <Frame Padding="0" HeightRequest="36" WidthRequest="36" CornerRadius="18" BackgroundColor="#F5F5F5" HasShadow="False" BorderColor="Transparent">
                        <Button Text="ðŸ‘¤" BackgroundColor="Transparent" TextColor="#333" FontSize="16" Padding="0" Clicked="OnAddFriendClicked"/>
                    </Frame>
                    <Grid WidthRequest="36" HeightRequest="36">
                        <Frame Padding="0" HeightRequest="36" WidthRequest="36" CornerRadius="18" BackgroundColor="#F5F5F5" HasShadow="False" BorderColor="Transparent">
                            <Button Text="ðŸ””" BackgroundColor="Transparent" TextColor="#333" FontSize="16" Padding="0" Clicked="OnNotificationClicked"/>
                        </Frame>
                        <Frame Padding="0" CornerRadius="6" BackgroundColor="Red" IsVisible="{Binding HasPendingRequests}" HorizontalOptions="End" VerticalOptions="Start" WidthRequest="12" HeightRequest="12" HasShadow="False"/>
                    </Grid>
                </HorizontalStackLayout>
            </Grid>

            <Grid Grid.Row="1" Padding="15,10">
                <Frame BackgroundColor="#F0F2F5" CornerRadius="12" Padding="4" HasShadow="False" BorderColor="Transparent" HeightRequest="44">
                    <Grid ColumnDefinitions="*,*">
                        <Button x:Name="BtnFriends" 
                                Text="Báº¡n bÃ¨" 
                                Grid.Column="0"
                                Clicked="OnTabChanged" 
                                CornerRadius="10"
                                FontAttributes="Bold"
                                FontSize="13"
                                BackgroundColor="{Binding FriendsTabColor}"
                                TextColor="{Binding FriendsTextColor}"
                                Padding="0"
                                HeightRequest="36"/>

                        <Button x:Name="BtnGroupChat" 
                                Text="NhÃ³m chung" 
                                Grid.Column="1"
                                Clicked="OnTabChanged"
                                CornerRadius="10"
                                FontAttributes="Bold"
                                FontSize="13"
                                BackgroundColor="{Binding GroupTabColor}"
                                TextColor="{Binding GroupTextColor}"
                                Padding="0"
                                HeightRequest="36"/>
                    </Grid>
                </Frame>
            </Grid>

            <Grid Grid.Row="2" Padding="15,0,15,10">
                <Frame Padding="10,0" CornerRadius="20" BackgroundColor="#F0F2F5" HasShadow="False" BorderColor="Transparent" HeightRequest="40">
                    <Grid ColumnDefinitions="30,*">
                        <Label Text="ðŸ”" VerticalOptions="Center" TextColor="#666" HorizontalOptions="Center"/>
                        <Entry x:Name="SearchEntry" Grid.Column="1" Placeholder="TÃ¬m kiáº¿m..." PlaceholderColor="#888" TextColor="Black" BackgroundColor="Transparent" FontSize="14" VerticalOptions="Center" TextChanged="OnSearchTextChanged"/>
                    </Grid>
                </Frame>
            </Grid>

            <CollectionView x:Name="ConversationsList"
                            Grid.Row="3"
                            ItemsSource="{Binding FilteredConversations}"
                            SelectionMode="Single"
                            SelectionChanged="OnConversationSelected">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="15,10" ColumnDefinitions="55,*,Auto" BackgroundColor="Transparent">
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup Name="CommonStates">
                                    <VisualState Name="Normal" />
                                    <VisualState Name="Selected">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" Value="#EAF3FF" />
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>

                            <Grid Grid.Column="0" VerticalOptions="Center">
                                <Frame WidthRequest="48" HeightRequest="48" CornerRadius="24" Padding="0" IsClippedToBounds="True" BorderColor="Transparent" BackgroundColor="#E0E0E0">
                                    <Label Text="{Binding InitialLetter}" FontSize="18" FontAttributes="Bold" TextColor="#333" HorizontalOptions="Center" VerticalOptions="Center"/>
                                </Frame>
                                <Frame WidthRequest="14" HeightRequest="14" CornerRadius="7" BackgroundColor="#4CAF50" HasShadow="False" Padding="0" HorizontalOptions="End" VerticalOptions="End" Margin="0,0,2,2" BorderColor="White" IsVisible="{Binding IsOnline}"/>
                            </Grid>

                            <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                <Label Text="{Binding DisplayName}" FontAttributes="Bold" FontSize="15" TextColor="Black" LineBreakMode="TailTruncation"/>
                                <Label Text="{Binding LastMessagePreview}" FontSize="13" TextColor="#666" LineBreakMode="TailTruncation"/>
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Column="2" VerticalOptions="Start" HorizontalOptions="End" Spacing="5">
                                <Label Text="{Binding LastMessageTime}" FontSize="11" TextColor="#999" HorizontalOptions="End"/>
                                <Frame Padding="0" WidthRequest="18" HeightRequest="18" CornerRadius="9" BackgroundColor="Red" HorizontalOptions="End" HasShadow="False" IsVisible="{Binding UnreadCount, Converter={StaticResource GreaterThanZeroConverter}}">
                                    <Label Text="{Binding UnreadCount}" FontSize="10" TextColor="White" FontAttributes="Bold" HorizontalOptions="Center" VerticalOptions="Center"/>
                                </Frame>
                            </VerticalStackLayout>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Grid Grid.Row="4" Padding="10" ColumnDefinitions="*,*" ColumnSpacing="10">
                <Button Text="Táº¡o nhÃ³m" Clicked="OnCreateGroupClicked" Grid.Column="0" BackgroundColor="#E4E6EB" TextColor="Black" HeightRequest="40" CornerRadius="10" FontAttributes="Bold" FontSize="13"/>
                <Button Text="Quáº£n lÃ½" Clicked="OnManageGroupClicked" Grid.Column="1" BackgroundColor="#E4E6EB" TextColor="Black" HeightRequest="40" CornerRadius="10" FontAttributes="Bold" FontSize="13"/>
            </Grid>
        </Grid>

        <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto" BackgroundColor="White">
            <Grid Grid.RowSpan="3" IsVisible="{Binding HasSelectedConversation, Converter={StaticResource InverseBooleanConverter}}" VerticalOptions="Center" HorizontalOptions="Center">
                <VerticalStackLayout Spacing="10" HorizontalOptions="Center">
                    <Label Text="ðŸ’¬" FontSize="60" HorizontalOptions="Center" TextColor="#E0E0E0"/>
                    <Label Text="Chá»n Ä‘oáº¡n chat Ä‘á»ƒ báº¯t Ä‘áº§u" FontSize="16" TextColor="Gray"/>
                </VerticalStackLayout>
            </Grid>

            <Grid Grid.RowSpan="3" RowDefinitions="Auto,*,Auto" IsVisible="{Binding HasSelectedConversation}">
                <Grid Grid.Row="0" Padding="15,10" ColumnDefinitions="Auto,*,Auto" BackgroundColor="White" ZIndex="1">
                    <Grid.Shadow>
                        <Shadow Brush="Black" Opacity="0.05" Radius="5" Offset="0,2"/>
                    </Grid.Shadow>

                    <Grid Grid.Column="0" Margin="0,0,10,0">
                        <Frame WidthRequest="40" HeightRequest="40" CornerRadius="20" Padding="0" IsClippedToBounds="True" BackgroundColor="#E4E6EB" BorderColor="Transparent">
                            <Label Text="{Binding CurrentConversation.InitialLetter}" FontSize="16" FontAttributes="Bold" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Black"/>
                        </Frame>
                        <BoxView WidthRequest="10" HeightRequest="10" CornerRadius="5" Color="{Binding CurrentConversation.OnlineColor}" HorizontalOptions="End" VerticalOptions="End" Margin="0,0,2,2" IsVisible="{Binding CurrentConversation.IsOnline}"/>
                    </Grid>

                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                        <Label Text="{Binding CurrentConversation.DisplayName}" FontAttributes="Bold" FontSize="16" TextColor="Black"/>
                        <Label Text="{Binding CurrentConversation.StatusText}" FontSize="12" TextColor="Gray"/>
                    </VerticalStackLayout>

                    <Button Grid.Column="2" Text="â„¹ï¸" BackgroundColor="Transparent" TextColor="#0084FF" FontSize="20" Clicked="OnChatOptionsClicked"/>
                </Grid>

                <ScrollView x:Name="MessageScrollView" Grid.Row="1" BackgroundColor="White" Padding="15">
                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding Messages}" Spacing="12">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="Auto,*" HorizontalOptions="{Binding Alignment}">
                                    <HorizontalStackLayout IsVisible="{Binding IsMine, Converter={StaticResource InverseBooleanConverter}}" Spacing="8">
                                        <Frame IsVisible="{Binding ShowSenderName}" WidthRequest="32" HeightRequest="32" CornerRadius="16" Padding="0" BackgroundColor="#E0E0E0" VerticalOptions="End" BorderColor="Transparent">
                                            <Label Text="ðŸ‘¤" HorizontalOptions="Center" VerticalOptions="Center" FontSize="12"/>
                                        </Frame>
                                        <Frame BackgroundColor="#F0F2F5" Padding="12,10" CornerRadius="18" HasShadow="False" BorderColor="Transparent" MaximumWidthRequest="400">
                                            <VerticalStackLayout>
                                                <Label Text="{Binding SenderName}" FontSize="11" TextColor="#666" IsVisible="{Binding ShowSenderName}" Margin="0,0,0,2"/>
                                                <Image Source="{Binding ImagePath}" IsVisible="{Binding HasImage}" WidthRequest="200" Aspect="AspectFit" Margin="0,0,0,5"/>
                                                <Label Text="{Binding Content}" TextColor="Black" FontSize="15"/>
                                                <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}" FontSize="10" TextColor="#999" HorizontalOptions="End" Margin="5,2,0,0"/>
                                            </VerticalStackLayout>
                                        </Frame>
                                    </HorizontalStackLayout>

                                    <HorizontalStackLayout IsVisible="{Binding IsMine}" Spacing="8">
                                        <Frame BackgroundColor="#0084FF" Padding="12,10" CornerRadius="18" HasShadow="False" BorderColor="Transparent" MaximumWidthRequest="400">
                                            <VerticalStackLayout>
                                                <Image Source="{Binding ImagePath}" IsVisible="{Binding HasImage}" WidthRequest="200" Aspect="AspectFit" Margin="0,0,0,5"/>
                                                <Label Text="{Binding Content}" TextColor="White" FontSize="15"/>
                                                <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}" FontSize="10" TextColor="#E0E0E0" HorizontalOptions="End" Margin="5,2,0,0"/>
                                            </VerticalStackLayout>
                                        </Frame>
                                    </HorizontalStackLayout>
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnMessageTapped"/>
                                    </Grid.GestureRecognizers>
                                </Grid>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                </ScrollView>

                <Grid Grid.Row="2" ColumnDefinitions="Auto,Auto,*,Auto" Padding="10" VerticalOptions="End" BackgroundColor="White">
                    <Button Text="ðŸ“·" Grid.Column="0" Clicked="OnSelectImageClicked" BackgroundColor="Transparent" TextColor="#0084FF" FontSize="18" WidthRequest="40"/>
                    <Button Text="ðŸ˜€" Grid.Column="1" Clicked="OnEmojiClicked" BackgroundColor="Transparent" TextColor="#0084FF" FontSize="18" WidthRequest="40"/>
                    <Frame Grid.Column="2" CornerRadius="20" BackgroundColor="#F0F2F5" HasShadow="False" Padding="15,0" Margin="5,0" BorderColor="Transparent">
                        <Editor x:Name="MessageEditor" Placeholder="Nháº­p tin nháº¯n..." PlaceholderColor="#888" TextColor="Black" BackgroundColor="Transparent" AutoSize="TextChanges" MaximumHeightRequest="100" VerticalOptions="Center" FontSize="15"/>
                    </Frame>
                    <Button Grid.Column="3" Text="âž¤" FontSize="20" Clicked="OnSendClicked" BackgroundColor="Transparent" TextColor="#0084FF" WidthRequest="50"/>
                </Grid>
            </Grid>
        </Grid>
    </Grid>
</ContentPage>