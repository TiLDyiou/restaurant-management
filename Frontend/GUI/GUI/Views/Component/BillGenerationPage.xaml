<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:RestaurantManagementGUI.ViewModels"
             xmlns:model="clr-namespace:RestaurantManagementGUI.Models"
             xmlns:converters="clr-namespace:RestaurantManagementGUI.Converters"
             x:Class="RestaurantManagementGUI.BillGenerationPage"
             Title="Thu NgÃ¢n"
             BackgroundColor="#F2F2F7">

    <ContentPage.Resources>
        <converters:BoolToColorConverter x:Key="BoolToColorConverter"/>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter"/>
    </ContentPage.Resources>

    <Grid ColumnDefinitions="300, 460, *" Padding="20" ColumnSpacing="20">

        <Border Grid.Column="0" BackgroundColor="White" StrokeShape="RoundRectangle 20" StrokeThickness="0" Padding="15">
            <Grid RowDefinitions="Auto, *">
                <Label Text="Danh sÃ¡ch chá»" FontSize="18" FontAttributes="Bold" TextColor="#333" Margin="0,0,0,15"/>

                <RefreshView Command="{Binding LoadPendingBillsCommand}" IsRefreshing="{Binding IsBusy}">
                    <CollectionView Grid.Row="1" ItemsSource="{Binding PendingBills}" SelectionMode="Single" 
                                    SelectedItem="{Binding SelectedBill, Mode=TwoWay}" EmptyView="KhÃ´ng cÃ³ Ä‘Æ¡n chá»">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="model:HoaDonModel">
                                <Border StrokeShape="RoundRectangle 12" StrokeThickness="0" Padding="12" Margin="0,0,0,10" BackgroundColor="#F8F9FA">
                                    <VisualStateManager.VisualStateGroups>
                                        <VisualStateGroup x:Name="CommonStates">
                                            <VisualState x:Name="Normal" />
                                            <VisualState x:Name="Selected">
                                                <VisualState.Setters>
                                                    <Setter Property="BackgroundColor" Value="#E8F5E9" />
                                                    <Setter Property="Stroke" Value="#4CAF50" />
                                                    <Setter Property="StrokeThickness" Value="2" />
                                                </VisualState.Setters>
                                            </VisualState>
                                        </VisualStateGroup>
                                    </VisualStateManager.VisualStateGroups>

                                    <Grid ColumnDefinitions="Auto, *" RowDefinitions="Auto, Auto">
                                        <Border Grid.RowSpan="2" HeightRequest="40" WidthRequest="40" StrokeShape="RoundRectangle 8" BackgroundColor="#8B6B47" Margin="0,0,10,0">
                                            <Label Text="{Binding TableName}" TextColor="White" FontSize="12" FontAttributes="Bold" HorizontalOptions="Center" VerticalOptions="Center"/>
                                        </Border>
                                        <Label Grid.Column="1" Text="{Binding FormattedTotal}" FontSize="15" FontAttributes="Bold" TextColor="#333"/>
                                        <Label Grid.Row="1" Grid.Column="1" Text="{Binding NgayLap, StringFormat='{0:HH:mm}'}" FontSize="12" TextColor="#888"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </RefreshView>
            </Grid>
        </Border>

        <ScrollView Grid.Column="1">
            <Border StrokeShape="RoundRectangle 20" BackgroundColor="White" StrokeThickness="0" Padding="0">
                <Grid RowDefinitions="Auto, *">
                    <Grid Grid.Row="0" BackgroundColor="#8B6B47" Padding="20">
                        <Label Text="{Binding SelectedBill.TableName, StringFormat='HÃ“A ÄÆ N - {0}'}" FontSize="18" FontAttributes="Bold" TextColor="White" HorizontalOptions="Center"/>
                    </Grid>

                    <Grid Grid.Row="1" Padding="25" RowDefinitions="Auto, *, Auto">
                        <StackLayout Grid.Row="0" Margin="0,0,0,20" Spacing="5">
                            <Label Text="{Binding SelectedBill.MaHD, StringFormat='MÃ£ HÄ: {0}'}" TextColor="#666"/>
                            <Label Text="{Binding SelectedBill.NgayLap, StringFormat='NgÃ y: {0:dd/MM/yyyy HH:mm}'}" TextColor="#666"/>
                        </StackLayout>

                        <CollectionView Grid.Row="1" ItemsSource="{Binding SelectedBill.ChiTietHoaDons}" Margin="0,0,0,20">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="model:ChiTietHoaDonModel">
                                    <Grid ColumnDefinitions="30, *, Auto" Padding="0,8">
                                        <Label Text="{Binding SoLuong}" FontAttributes="Bold" TextColor="#333"/>
                                        <Label Grid.Column="1" Text="{Binding TenMA}" TextColor="#333"/>
                                        <Label Grid.Column="2" Text="{Binding ThanhTien, StringFormat='{0:N0}'}" TextColor="#333"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <VerticalStackLayout Grid.Row="2" Spacing="10">
                            <BoxView HeightRequest="1" Color="#DDD"/>
                            <Grid ColumnDefinitions="*, Auto">
                                <Label Text="Tá»”NG Cá»˜NG" FontAttributes="Bold" FontSize="18" TextColor="#333"/>
                                <Label Grid.Column="1" Text="{Binding SelectedBill.FormattedTotal}" FontAttributes="Bold" FontSize="22" TextColor="#D32F2F"/>
                            </Grid>
                            <Label Text="Cáº£m Æ¡n quÃ½ khÃ¡ch!" FontSize="14" FontAttributes="Italic" TextColor="#888" HorizontalOptions="Center" Margin="0,10,0,0"/>
                        </VerticalStackLayout>
                    </Grid>
                </Grid>
            </Border>
        </ScrollView>

        <Border Grid.Column="2" BackgroundColor="White" StrokeShape="RoundRectangle 20" Padding="25">
            <ScrollView>
                <VerticalStackLayout Spacing="20">
                    <Label Text="Thanh ToÃ¡n" FontSize="22" FontAttributes="Bold" TextColor="#333"/>

                    <Border StrokeShape="RoundRectangle 12" Padding="15" StrokeThickness="2">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsCashPayment}" Value="True">
                                <Setter Property="Stroke" Value="#4CAF50"/>
                                <Setter Property="BackgroundColor" Value="#F1F8E9"/>
                            </DataTrigger>
                            <DataTrigger TargetType="Border" Binding="{Binding IsCashPayment}" Value="False">
                                <Setter Property="Stroke" Value="#EEEEEE"/>
                                <Setter Property="BackgroundColor" Value="Transparent"/>
                            </DataTrigger>
                        </Border.Triggers>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectCashCommand}"/>
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="15">
                            <Label Text="ðŸ’µ" FontSize="24" VerticalOptions="Center"/>
                            <VerticalStackLayout>
                                <Label Text="Tiá»n máº·t" FontAttributes="Bold" TextColor="#333"/>
                                <Label Text="Thanh toÃ¡n táº¡i quáº§y" FontSize="12" TextColor="#888"/>
                            </VerticalStackLayout>
                        </HorizontalStackLayout>
                    </Border>

                    <VerticalStackLayout IsVisible="{Binding IsCashPayment}" Spacing="8">
                        <Label Text="Tiá»n khÃ¡ch Ä‘Æ°a:" TextColor="#666"/>
                        <Border Stroke="#DDD" StrokeShape="RoundRectangle 8" Padding="10,0" HeightRequest="45">
                            <Entry Text="{Binding CustomerPayAmount}" Placeholder="Nháº­p sá»‘ tiá»n..." Keyboard="Numeric" FontSize="16" VerticalOptions="Center"/>
                        </Border>

                        <Label Text="{Binding ChangeAmount, StringFormat='Tiá»n thá»«a: {0:N0} Ä‘'}" 
                               TextColor="#4CAF50" FontAttributes="Bold" FontSize="16"
                               IsVisible="{Binding ChangeAmount, Converter={StaticResource InvertedBoolConverter}}"/>
                    </VerticalStackLayout>

                    <Border StrokeShape="RoundRectangle 12" Padding="15" StrokeThickness="2">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsTransferPayment}" Value="True">
                                <Setter Property="Stroke" Value="#2196F3"/>
                                <Setter Property="BackgroundColor" Value="#E3F2FD"/>
                            </DataTrigger>
                            <DataTrigger TargetType="Border" Binding="{Binding IsTransferPayment}" Value="False">
                                <Setter Property="Stroke" Value="#EEEEEE"/>
                                <Setter Property="BackgroundColor" Value="Transparent"/>
                            </DataTrigger>
                        </Border.Triggers>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectTransferCommand}"/>
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="15">
                            <Label Text="ðŸ“±" FontSize="24" VerticalOptions="Center"/>
                            <VerticalStackLayout>
                                <Label Text="Chuyá»ƒn khoáº£n / QR" FontAttributes="Bold" TextColor="#333"/>
                                <Label Text="QuÃ©t mÃ£ ngÃ¢n hÃ ng" FontSize="12" TextColor="#888"/>
                            </VerticalStackLayout>
                        </HorizontalStackLayout>
                    </Border>

                    <Border IsVisible="{Binding IsTransferPayment}" HeightRequest="220" WidthRequest="220" HorizontalOptions="Center" StrokeShape="RoundRectangle 10" Stroke="#E0E0E0">
                        <Grid>
                            <ActivityIndicator IsRunning="True" Color="#8B6B47" HorizontalOptions="Center" VerticalOptions="Center"/>
                            <Image Source="{Binding QrCodeUrl}" Aspect="AspectFit" HorizontalOptions="Fill" VerticalOptions="Fill"/>
                        </Grid>
                    </Border>

                    <Button Text="XÃC NHáº¬N THANH TOÃN" 
                            Command="{Binding PayAndPrintCommand}"
                            IsEnabled="{Binding CanPay}"
                            BackgroundColor="#8B6B47" TextColor="White" FontAttributes="Bold" HeightRequest="50" CornerRadius="10" Margin="0,20,0,0">
                        <Button.Triggers>
                            <Trigger TargetType="Button" Property="IsEnabled" Value="False">
                                <Setter Property="BackgroundColor" Value="#CCC"/>
                            </Trigger>
                        </Button.Triggers>
                    </Button>
                </VerticalStackLayout>
            </ScrollView>
        </Border>
    </Grid>
</ContentPage>