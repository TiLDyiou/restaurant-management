<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:RestaurantManagementGUI.ViewModels"
             xmlns:model="clr-namespace:RestaurantManagementGUI.Models"
             xmlns:converters="clr-namespace:RestaurantManagementGUI.Converters"
             x:Class="RestaurantManagementGUI.BillGenerationPage"
             x:DataType="vm:BillGenerationViewModel"
             Title="Thu NgÃ¢n"
             BackgroundColor="#F2F2F7">

    <Grid x:Name="MainLayout" Padding="10" ColumnSpacing="10" RowSpacing="10">

        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <VisualState x:Name="Desktop">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1000" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter TargetName="MainLayout" Property="Grid.RowDefinitions" Value="*, Auto" />
                        <Setter TargetName="MainLayout" Property="Grid.ColumnDefinitions" Value="280, 460, *" />
                        <Setter TargetName="LeftPanel" Property="Grid.Column" Value="0" />
                        <Setter TargetName="LeftPanel" Property="Grid.Row" Value="0" />
                        <Setter TargetName="LeftPanel" Property="Grid.RowSpan" Value="2" />
                        <Setter TargetName="MiddlePanel" Property="Grid.Column" Value="1" />
                        <Setter TargetName="MiddlePanel" Property="Grid.Row" Value="0" />
                        <Setter TargetName="MiddlePanel" Property="Grid.RowSpan" Value="2" />
                        <Setter TargetName="RightPanel" Property="Grid.Column" Value="2" />
                        <Setter TargetName="RightPanel" Property="Grid.Row" Value="0" />
                        <Setter TargetName="RightPanel" Property="Grid.RowSpan" Value="2" />
                    </VisualState.Setters>
                </VisualState>

                <VisualState x:Name="Phone">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter TargetName="MainLayout" Property="Grid.ColumnDefinitions" Value="*" />
                        <Setter TargetName="MainLayout" Property="Grid.RowDefinitions" Value="Auto, 4*, 6*" />

                        <Setter TargetName="LeftPanel" Property="Grid.Column" Value="0" />
                        <Setter TargetName="LeftPanel" Property="Grid.Row" Value="0" />
                        <Setter TargetName="LeftPanel" Property="Grid.RowSpan" Value="1" />
                        <Setter TargetName="LeftPanel" Property="HeightRequest" Value="140" />

                        <Setter TargetName="MiddlePanel" Property="Grid.Column" Value="0" />
                        <Setter TargetName="MiddlePanel" Property="Grid.Row" Value="1" />
                        <Setter TargetName="MiddlePanel" Property="Grid.RowSpan" Value="1" />

                        <Setter TargetName="RightPanel" Property="Grid.Column" Value="0" />
                        <Setter TargetName="RightPanel" Property="Grid.Row" Value="2" />
                        <Setter TargetName="RightPanel" Property="Grid.RowSpan" Value="1" />
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <Border x:Name="LeftPanel" 
                BackgroundColor="White" StrokeShape="RoundRectangle 20" StrokeThickness="0" Padding="15">
            <Border.Shadow>
                <Shadow Brush="Black" Opacity="0.05" Radius="10" Offset="0,2"/>
            </Border.Shadow>
            <Grid RowDefinitions="Auto, *">
                <Label Text="Danh sÃ¡ch chá»" FontSize="18" FontAttributes="Bold" TextColor="#333" Margin="0,0,0,15"/>
                <CollectionView Grid.Row="1" ItemsSource="{Binding PendingBills}" SelectionMode="Single" SelectedItem="{Binding SelectedBill, Mode=TwoWay}" EmptyView="KhÃ´ng cÃ³ Ä‘Æ¡n chá»">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="10"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="model:HoaDonDto">
                            <Border StrokeShape="RoundRectangle 12" StrokeThickness="0" Padding="12" BackgroundColor="#F8F9FA">
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroupList>
                                        <VisualStateGroup x:Name="CommonStates">
                                            <VisualState x:Name="Normal" />
                                            <VisualState x:Name="Selected">
                                                <VisualState.Setters>
                                                    <Setter Property="BackgroundColor" Value="#E8F5E9" />
                                                    <Setter Property="Stroke" Value="#4CAF50" />
                                                    <Setter Property="StrokeThickness" Value="1" />
                                                </VisualState.Setters>
                                            </VisualState>
                                        </VisualStateGroup>
                                    </VisualStateGroupList>
                                </VisualStateManager.VisualStateGroups>
                                <Grid ColumnDefinitions="Auto, *" RowDefinitions="Auto, Auto">
                                    <Border Grid.RowSpan="2" HeightRequest="40" WidthRequest="70" StrokeShape="RoundRectangle 8" BackgroundColor="#8B6B47" Margin="0,0,10,0">
                                        <Label Text="{Binding TableName}" TextColor="White" FontSize="14" FontAttributes="Bold" HorizontalOptions="Center" VerticalOptions="Center" LineBreakMode="TailTruncation"/>
                                    </Border>
                                    <Label Grid.Column="1" Text="{Binding FormattedTotal}" FontSize="15" FontAttributes="Bold" TextColor="#333"/>
                                    <Label Grid.Row="1" Grid.Column="1" Text="{Binding NgayLap, StringFormat='{0:HH:mm}'}" FontSize="12" TextColor="#888"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
        </Border>

        <ScrollView x:Name="MiddlePanel">
            <Border StrokeShape="RoundRectangle 20" BackgroundColor="#8B6B47" StrokeThickness="0" Padding="0">
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.15" Radius="15" Offset="0,5"/>
                </Border.Shadow>
                <Grid RowDefinitions="Auto, *">
                    <Grid Grid.Row="0" BackgroundColor="#8B6B47" Padding="20">
                        <Label Text="{Binding SelectedBill.TableName, StringFormat='HÃ“A ÄÆ N - {0}'}" FontSize="18" FontAttributes="Bold" TextColor="White" HorizontalOptions="Center"/>
                    </Grid>
                    <BoxView HeightRequest="15" BackgroundColor="#F5F5F5" VerticalOptions="End" Margin="0"/>

                    <Border Grid.Row="1" BackgroundColor="#F5F5F5" Padding="25" StrokeThickness="0">
                        <Grid RowDefinitions="Auto, Auto, *, Auto, Auto, Auto">
                            <StackLayout Grid.Row="0" Margin="0,0,0,20">
                                <Label Text="{Binding SelectedBill.MaHD, StringFormat='MÃ£ HÄ: {0}'}" TextColor="#666"/>
                                <Label Text="{Binding SelectedBill.NgayLap, StringFormat='NgÃ y: {0:dd/MM/yyyy HH:mm}'}" TextColor="#666"/>
                            </StackLayout>
                            <CollectionView Grid.Row="2" ItemsSource="{Binding SelectedBill.ChiTietHoaDons}" Margin="0,0,0,20">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="model:ChiTietHoaDonViewDto">
                                        <Grid ColumnDefinitions="30, *, Auto" Padding="0,5">
                                            <Label Text="{Binding SoLuong}" FontAttributes="Bold" TextColor="#333"/>
                                            <Label Grid.Column="1" Text="{Binding TenMA}" TextColor="#333"/>
                                            <Label Grid.Column="2" Text="{Binding ThanhTien, StringFormat='{0:N0}'}" TextColor="#333"/>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                            <BoxView Grid.Row="3" HeightRequest="1" Color="#CCC" Margin="0,10"/>
                            <Grid Grid.Row="4" ColumnDefinitions="*, Auto">
                                <Label Text="Tá»”NG Cá»˜NG" FontAttributes="Bold" FontSize="18" TextColor="#333"/>
                                <Label Grid.Column="1" Text="{Binding SelectedBill.FormattedTotal}" FontAttributes="Bold" FontSize="22" TextColor="#8B6B47"/>
                            </Grid>

                            <Label Grid.Row="5" Text="Cáº£m Æ¡n vÃ  háº¹n gáº·p láº¡i quÃ½ khÃ¡ch!" FontSize="14" FontAttributes="Italic" TextColor="#888" HorizontalOptions="Center" Margin="0,25,0,0"/>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </ScrollView>

        <Border x:Name="RightPanel" 
                BackgroundColor="White" StrokeShape="RoundRectangle 20" Padding="25">
            <ScrollView>
                <VerticalStackLayout Spacing="20">
                    <Label Text="Thanh ToÃ¡n" FontSize="22" FontAttributes="Bold" TextColor="#333"/>

                    <Border StrokeShape="RoundRectangle 12" Padding="15" StrokeThickness="2" Stroke="{Binding IsCashPayment, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#4CAF50|#EEEEEE'}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectCashPaymentCommand}"/>
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="15">
                            <Label Text="ðŸ’µ" FontSize="24" VerticalOptions="Center"/>
                            <VerticalStackLayout>
                                <Label Text="Tiá»n máº·t" FontAttributes="Bold" TextColor="#333"/>
                                <Label Text="Thanh toÃ¡n táº¡i quáº§y" FontSize="12" TextColor="#888"/>
                            </VerticalStackLayout>
                        </HorizontalStackLayout>
                    </Border>

                    <VerticalStackLayout IsVisible="{Binding IsCashPayment}" Spacing="5">
                        <Label Text="Tiá»n khÃ¡ch Ä‘Æ°a:" TextColor="#666"/>
                        <Border Stroke="#DDD" StrokeShape="RoundRectangle 8" Padding="10,0">
                            <Entry Text="{Binding CustomerPayAmount}" Placeholder="Nháº­p sá»‘ tiá»n..." Keyboard="Numeric" FontSize="16"/>
                        </Border>
                        <Label Text="{Binding ChangeAmount, StringFormat='Tiá»n thá»«a: {0:N0} Ä‘'}" TextColor="#4CAF50" FontAttributes="Bold" IsVisible="{Binding ShowChange}"/>
                    </VerticalStackLayout>

                    <Border StrokeShape="RoundRectangle 12" Padding="15" StrokeThickness="2" Stroke="{Binding IsTransferPayment, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#2196F3|#EEEEEE'}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectTransferPaymentCommand}"/>
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="15">
                            <Label Text="ðŸ“±" FontSize="24" VerticalOptions="Center"/>
                            <VerticalStackLayout>
                                <Label Text="Chuyá»ƒn khoáº£n / QR" FontAttributes="Bold" TextColor="#333"/>
                                <Label Text="QuÃ©t mÃ£ ngÃ¢n hÃ ng" FontSize="12" TextColor="#888"/>
                            </VerticalStackLayout>
                        </HorizontalStackLayout>
                    </Border>

                    <Border IsVisible="{Binding IsTransferPayment}" 
                            HeightRequest="220" 
                            WidthRequest="220" 
                            HorizontalOptions="Center" 
                            BackgroundColor="White"
                            StrokeShape="RoundRectangle 10"
                            Stroke="#E0E0E0"
                            StrokeThickness="1">

                        <Grid>
                            <ActivityIndicator IsRunning="True" Color="#8B6B47" HorizontalOptions="Center" VerticalOptions="Center"/>

                            <Image Source="{Binding QrCodeUrl}" 
                                   Aspect="AspectFit"
                                   HorizontalOptions="Fill"
                                   VerticalOptions="Fill"/>
                        </Grid>
                    </Border>
                    <Button Text="XÃC NHáº¬N THANH TOÃN" Command="{Binding PayAndPrintCommand}" BackgroundColor="#8B6B47" TextColor="White" FontAttributes="Bold" HeightRequest="50" CornerRadius="10" Margin="0,20,0,0"/>
                </VerticalStackLayout>
            </ScrollView>
        </Border>

    </Grid>
</ContentPage>