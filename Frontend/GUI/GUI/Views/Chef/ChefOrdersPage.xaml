<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:RestaurantManagementGUI.ViewModels"
             xmlns:models="clr-namespace:RestaurantManagementGUI.Models"
             xmlns:converters="clr-namespace:RestaurantManagementGUI.Converters"
             xmlns:local="clr-namespace:RestaurantManagementGUI"
             x:Class="RestaurantManagementGUI.ChefOrdersPage"
             x:Name="ChefPage"
             Title="Báº¾P - NHáº¬N ÄÆ N"
             BackgroundColor="DimGrey">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:TableIdConverter x:Key="TableIdConverter" />
            <converters:StatusColorConverter x:Key="StatusColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <Grid RowDefinitions="Auto, *" ZIndex="0">

            <Grid Grid.Row="0" ColumnDefinitions="*, Auto" Padding="20">
                <Label Text="ðŸ‘¨â€ðŸ³ ÄÆ N HÃ€NG Cáº¦N CHáº¾ BIáº¾N" 
                       FontSize="24" FontAttributes="Bold" TextColor="#FFC107" VerticalOptions="Center"/>

                <Grid Grid.Column="1" WidthRequest="50" HeightRequest="50">
                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ToggleNotificationsCommand}"/>
                    </Grid.GestureRecognizers>
                    <Label Text="ðŸ””" FontSize="30" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center"/>
                    <Border BackgroundColor="Red" StrokeShape="RoundRectangle 10" StrokeThickness="0"
                            HeightRequest="20" WidthRequest="20" HorizontalOptions="End" VerticalOptions="Start"
                            Margin="0,5,5,0" IsVisible="{Binding HasNewOrders}">
                        <Label Text="{Binding NewOrderCount}" TextColor="White" FontSize="12" FontAttributes="Bold" HorizontalOptions="Center" VerticalOptions="Center"/>
                    </Border>
                </Grid>
            </Grid>

            <CollectionView Grid.Row="1" ItemsSource="{Binding ActiveOrders}" Margin="10" SelectionMode="None">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" Span="2" VerticalItemSpacing="15" HorizontalItemSpacing="15"/>
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:HoaDonDto">
                        <Border StrokeShape="RoundRectangle 15" StrokeThickness="0" BackgroundColor="White" Padding="0">
                            <Grid RowDefinitions="Auto, *, Auto" Padding="15">

                                <Grid Grid.Row="0" ColumnDefinitions="Auto, *" Margin="0,0,0,10">
                                    <Border BackgroundColor="#D32F2F" StrokeShape="RoundRectangle 8" Padding="15,5">
                                        <Label Text="{Binding MaBan, Converter={StaticResource TableIdConverter}}" 
                                               TextColor="White" FontAttributes="Bold" FontSize="20"/>
                                    </Border>
                                    <Label Grid.Column="1" Text="{Binding NgayLap, StringFormat='{0:HH:mm}'}" 
                                           TextColor="Gray" FontSize="16" HorizontalOptions="End" VerticalOptions="Center"/>
                                </Grid>

                                <StackLayout Grid.Row="1" BindableLayout.ItemsSource="{Binding ChiTietHoaDons}" Spacing="8">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="models:ChiTietHoaDonViewDto">
                                            <Grid ColumnDefinitions="40, *, 50">

                                                <Label Text="{Binding SoLuong}" TextColor="#D32F2F" FontAttributes="Bold" FontSize="20" VerticalOptions="Center"/>

                                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                                                    <Label Text="{Binding TenMA}" TextColor="#263238" FontAttributes="Bold" FontSize="18">
                                                        <Label.Triggers>
                                                            <DataTrigger TargetType="Label" Binding="{Binding IsDone}" Value="True">
                                                                <Setter Property="TextDecorations" Value="Strikethrough" />
                                                                <Setter Property="TextColor" Value="Gray" />
                                                                <Setter Property="Opacity" Value="0.6" />
                                                            </DataTrigger>
                                                        </Label.Triggers>
                                                    </Label>
                                                    <Label Text="{Binding TrangThai}" TextColor="Gray" FontSize="12" FontAttributes="Italic"/>
                                                </VerticalStackLayout>

                                                <Border Grid.Column="2" 
                                                        HeightRequest="40" WidthRequest="40" 
                                                        StrokeShape="RoundRectangle 20" StrokeThickness="0"
                                                        BackgroundColor="{Binding IsDone, Converter={StaticResource StatusColorConverter}}">

                                                    <Label Text="âœ”" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" FontAttributes="Bold"/>

                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={x:Reference ChefPage}, Path=BindingContext.CompleteDishCommand}"
                                                            CommandParameter="{Binding .}"/>
                                                    </Border.GestureRecognizers>

                                                    <Border.Triggers>
                                                        <DataTrigger TargetType="Border" Binding="{Binding IsDone}" Value="True">
                                                            <Setter Property="BackgroundColor" Value="Gray"/>
                                                            <Setter Property="InputTransparent" Value="True"/>
                                                        </DataTrigger>
                                                    </Border.Triggers>
                                                </Border>

                                            </Grid>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </StackLayout>

                                <Border Grid.Row="2" BackgroundColor="#1E2630" StrokeShape="RoundRectangle 8" Padding="10" Margin="0,15,0,0">
                                    <Label Text="XONG Cáº¢ BÃ€N" TextColor="White" FontAttributes="Bold" HorizontalOptions="Center"/>

                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer 
                                            Command="{Binding Source={x:Reference ChefPage}, Path=BindingContext.CompleteOrderCommand}"
                                            CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>

                                    <Border.Triggers>
                                        <DataTrigger TargetType="Border" Binding="{Binding IsPressed}" Value="True">
                                            <Setter Property="Opacity" Value="0.7"/>
                                        </DataTrigger>
                                    </Border.Triggers>
                                </Border>

                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <ContentView IsVisible="{Binding ShowNotificationPopup}" BackgroundColor="Transparent" ZIndex="99" InputTransparent="False">
            <ContentView.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding ToggleNotificationsCommand}"/>
            </ContentView.GestureRecognizers>

            <Border BackgroundColor="#2c3e50" Stroke="#FFC107" StrokeThickness="1" StrokeShape="RoundRectangle 10"
                    WidthRequest="320" HeightRequest="300" HorizontalOptions="End" VerticalOptions="Start"
                    Margin="0,75,20,0" Padding="15">
                <Border.GestureRecognizers>
                    <TapGestureRecognizer />
                </Border.GestureRecognizers>

                <Grid RowDefinitions="Auto, *, Auto">
                    <Label Text="ðŸ”” ThÃ´ng bÃ¡o má»›i nháº¥t" TextColor="#FFC107" FontAttributes="Bold" FontSize="16" Margin="0,0,0,10"/>
                    <CollectionView Grid.Row="1" ItemsSource="{Binding NotificationList}">
                        <CollectionView.EmptyView>
                            <Label Text="KhÃ´ng cÃ³ thÃ´ng bÃ¡o nÃ o." TextColor="Gray" HorizontalOptions="Center" VerticalOptions="Center" Margin="0,20,0,0"/>
                        </CollectionView.EmptyView>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="0,5" ColumnDefinitions="Auto, *">
                                    <Label Text="â€¢" TextColor="#FFC107" Margin="0,0,8,0" FontSize="18"/>
                                    <Label Grid.Column="1" Text="{Binding .}" TextColor="White" FontSize="14" LineBreakMode="WordWrap"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                    <Button Grid.Row="2" Text="XÃ³a táº¥t cáº£" Command="{Binding ClearAllNotificationsCommand}"
                            BackgroundColor="Transparent" TextColor="#FF6B6B" FontSize="13" 
                            HorizontalOptions="End" Margin="0,10,0,0"/>
                </Grid>
            </Border>
        </ContentView>
    </Grid>
</ContentPage>