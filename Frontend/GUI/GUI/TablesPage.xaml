<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewModels="clr-namespace:RestaurantManagementGUI.ViewModels"
    xmlns:models="clr-namespace:RestaurantManagementGUI.Models"
    xmlns:local="clr-namespace:RestaurantManagementGUI"
    x:Class="RestaurantManagementGUI.TablesPage"
    Shell.NavBarIsVisible="False"
    Shell.NavBarHasShadow="False"
    Title=""
    Padding="0">

    <ContentPage.Resources>
        <Color x:Key="ColorDarkBrown">#503106</Color>
        <Color x:Key="ColorLightTan">#fff8ed</Color>
        <Color x:Key="ColorYellowGold">#ffbd59</Color>
        <Color x:Key="ColorDarkGray">#263238</Color>

        <Style TargetType="Image" x:Key="TableIconStyle">
            <Setter Property="Source" Value="table_icon_dark_gray.png" />
            <Setter Property="HeightRequest" Value="72" />
            <Setter Property="WidthRequest" Value="72" />
            <Setter Property="HorizontalOptions" Value="Center" />
            <Setter Property="VerticalOptions" Value="Center" />
        </Style>

        <Style TargetType="Label" x:Key="TableNameStyle">
            <Setter Property="FontSize" Value="18" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="HorizontalOptions" Value="Center" />
            <Setter Property="FontFamily" Value="RobotoMono" />
        </Style>

        <Style TargetType="Border" x:Key="TableBorderStyle">
            <Setter Property="StrokeShape" Value="RoundRectangle 24" />
            <Setter Property="StrokeThickness" Value="0" />
            <Setter Property="Padding" Value="12" />
            <Setter Property="HeightRequest" Value="150" />
            <Setter Property="WidthRequest" Value="150" />
            <Setter Property="HorizontalOptions" Value="Center" />
            <Setter Property="VerticalOptions" Value="Center" />
            <Setter Property="Shadow">
                <Setter.Value>
                    <Shadow Brush="#22000000" Offset="0,6" Radius="10" Opacity="0.6" />
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="Border" x:Key="LegendBorderStyle">
            <Setter Property="StrokeShape" Value="RoundRectangle 18" />
            <Setter Property="StrokeThickness" Value="0" />
            <Setter Property="HeightRequest" Value="42" />
            <Setter Property="Padding" Value="18,6" />
        </Style>
    </ContentPage.Resources>

    <!-- CONTAINER CHÍNH -->
    <Grid>
        <!-- NỘI DUNG CHÍNH (Sơ đồ bàn) -->
        <Grid RowDefinitions="Auto, *" Padding="0" Margin="0,-50,0,0">

            <Image Source="amthuc.jpg"
                   Aspect="AspectFill"
                   Opacity="0.55"
                   Grid.Row="0"
                   Grid.RowSpan="2"
                   VerticalOptions="FillAndExpand"
                   HorizontalOptions="FillAndExpand" />

            <Grid Grid.Row="0" Grid.RowSpan="2" Padding="0">
                <Grid Padding="10,20,10,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- HEADER: Chỉ có nút Hamburger -->
                    <Grid Grid.Row="0" Padding="5,0" Margin="0,0,0,10">
                        <!-- Nút Hamburger -->
                        <Border BackgroundColor="{StaticResource ColorYellowGold}"
                                StrokeShape="RoundRectangle 16"
                                Stroke="{StaticResource ColorDarkBrown}"
                                StrokeThickness="2"
                                Padding="12"
                                HeightRequest="52"
                                WidthRequest="52"
                                VerticalOptions="Center"
                                HorizontalOptions="Start">
                            <Border.Shadow>
                                <Shadow Brush="#33000000" Offset="0,4" Radius="12" Opacity="0.6" />
                            </Border.Shadow>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnHamburgerTapped" />
                            </Border.GestureRecognizers>
                            <Label Text="&#xe5d2;"
                                   FontFamily="MaterialIcons"
                                   FontSize="28"
                                   TextColor="{StaticResource ColorDarkBrown}"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center" />
                        </Border>
                    </Grid>

                    <!-- COLLECTION VIEW: Danh sách bàn -->
                    <ScrollView Grid.Row="1">
                        <CollectionView x:Name="TablesCollectionView"
                                        ItemsSource="{Binding Tables}"
                                        SelectionMode="None">
                            <CollectionView.ItemsLayout>
                                <GridItemsLayout Orientation="Vertical" Span="3"
                                                 HorizontalItemSpacing="12"
                                                 VerticalItemSpacing="12" />
                            </CollectionView.ItemsLayout>

                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:Ban">
                                    <Border Style="{StaticResource TableBorderStyle}">

                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer
                                                Command="{Binding BindingContext.SelectTableCommand, Source={RelativeSource AncestorType={x:Type local:TablesPage}}}"
                                                CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>

                                        <VerticalStackLayout Spacing="6"
                                                             HorizontalOptions="Center"
                                                             VerticalOptions="Center">
                                            <Image x:Name="TableIcon" Style="{StaticResource TableIconStyle}" />
                                            <Label x:Name="TableName" Text="{Binding TenBan}" Style="{StaticResource TableNameStyle}" />
                                        </VerticalStackLayout>

                                        <Border.Triggers>

                                            <DataTrigger TargetType="Border"
                                                         Binding="{Binding TrangThai}"
                                                         Value="Bàn bận">
                                                <Setter Property="BackgroundColor" Value="{StaticResource ColorDarkBrown}" />
                                                <Setter TargetName="TableIcon" Property="Image.Source" Value="table_icon_light_orange.png" />
                                                <Setter TargetName="TableName" Property="Label.TextColor" Value="{StaticResource ColorLightTan}" />
                                            </DataTrigger>

                                            <DataTrigger TargetType="Border"
                                                         Binding="{Binding TrangThai}"
                                                         Value="Bàn đã đặt">
                                                <Setter Property="BackgroundColor" Value="{StaticResource ColorYellowGold}" />
                                                <Setter TargetName="TableIcon" Property="Image.Source" Value="table_icon_dark_brown.png" />
                                                <Setter TargetName="TableName" Property="Label.TextColor" Value="{StaticResource ColorDarkBrown}" />
                                            </DataTrigger>

                                            <DataTrigger TargetType="Border"
                                                         Binding="{Binding TrangThai}"
                                                         Value="Bàn trống">
                                                <Setter Property="BackgroundColor" Value="{StaticResource ColorLightTan}" />
                                                <Setter TargetName="TableIcon" Property="Image.Source" Value="table_icon_dark_gray.png" />
                                                <Setter TargetName="TableName" Property="Label.TextColor" Value="{StaticResource ColorDarkGray}" />
                                            </DataTrigger>

                                        </Border.Triggers>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </ScrollView>

                    <!-- FOOTER: Legend -->
                    <HorizontalStackLayout Grid.Row="2"
                                           Spacing="12"
                                           HorizontalOptions="Center"
                                           Margin="0,18,0,18">

                        <Border Style="{StaticResource LegendBorderStyle}" BackgroundColor="{StaticResource ColorDarkBrown}">
                            <Label Text="Bàn bận"
                                   TextColor="{StaticResource ColorLightTan}"
                                   VerticalOptions="Center"
                                   FontFamily="RobotoMono"
                                   FontAttributes="Bold" />
                        </Border>

                        <Border Style="{StaticResource LegendBorderStyle}" BackgroundColor="{StaticResource ColorLightTan}">
                            <Label Text="Bàn trống"
                                   TextColor="{StaticResource ColorDarkGray}"
                                   VerticalOptions="Center"
                                   FontFamily="RobotoMono"
                                   FontAttributes="Bold" />
                        </Border>

                        <Border Style="{StaticResource LegendBorderStyle}" BackgroundColor="{StaticResource ColorYellowGold}">
                            <Label Text="Bàn đã đặt"
                                   TextColor="{StaticResource ColorDarkBrown}"
                                   VerticalOptions="Center"
                                   FontFamily="RobotoMono"
                                   FontAttributes="Bold" />
                        </Border>

                    </HorizontalStackLayout>
                </Grid>
            </Grid>
        </Grid>

        <!-- FLYOUT MENU (Overlay trên cùng) -->
        <local:FlyoutMenuView x:Name="FlyoutMenu"
                              ChangeStatusRequested="OnFlyoutChangeStatusRequested"
                              ViewAddOrderRequested="OnFlyoutViewAddOrderRequested"
                              PaymentRequested="OnFlyoutPaymentRequested"
                              RefreshRequested="OnFlyoutRefreshRequested"
                              FilterChanged="OnFlyoutFilterChanged" />
    </Grid>

</ContentPage>